<!DOCTYPE html>
<html>
  <head>
    <title>eCloud</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
      <script src="javascripts/Tween.js"></script>



      <script type="application/javascript" src="bower_components/Processing.js/processing.js"></script>
      <script type="application/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
      <script type="application/javascript" src="bower_components/lodash/lodash.js"></script>
      <script type="application/javascript" src="bower_components/tinycolor/tinycolor.js"></script>

      <script type="application/javascript" src="javascripts/Tuio.js"></script>
      <script src="socket.io/socket.io.js"></script>
      <script type="application/javascript">
          var socket = io();
      </script>
      <script src="socket.io/socket.io.js"></script>
      <script type="application/javascript" src="http://localhost:5000/libs/socket.io.js"></script>

      <script src="javascripts/map.js"></script>
      <script src="javascripts/parsePaperData.js"></script>
      <script src="javascripts/CountryResults.js"></script>
      <script src="javascripts/Timeline.js"></script>
      <script src="javascripts/Newspaper.js"></script>
      <script src="javascripts/Console.js"></script>
      <script src="javascripts/LoadingIcon.js"></script>
      <script src="javascripts/visualization.js"></script>



  </head>
  <body onload="javascript:loadAll();">
   <div id="map"></div>
  <canvas id="overlay"></canvas>
  </body>
<script type="application/javascript">
    var __vis;
    var __users;
    var __solos;
    var __query;
    var loadAll = function() {
        var _width = $(window).width();
        var _height = $(window).height();
        $("#overlay").width(_width);
        $("#overlay").height(_height);
        $("#map").width(_width);
        $("#map").height(_height);


        __loadingHandler.init(_width-100,10);

        generateMap();
        var modules = [__countryHandler];
        var extras = [__loadingHandler];
        __vis = new visualization();
        __vis.init("overlay", modules,extras);

        //connect to socket.io

        socket.emit("registerVisualization");
        socket.on("update", function (msg) {
            initCountries(function(){

                var data = msg;
                modules.forEach(function(m){
                    m.update(data);
                });
                __loadingHandler.hide();

            });

        });
        socket.on("busy",function(){
            __loadingHandler.show();
        })



        //TUIO STUFF
        var client = new Tuio.Client({
                    host: "http://localhost:5000"
                }),

                onAddTuioCursor = function(addCursor) {
                    var x = addCursor.getScreenX(_width);
                    var y = addCursor.getScreenY(_height);
                    __vis.addTouch(addCursor.cursorId,x,y);

                },

                onUpdateTuioCursor = function(updateCursor) {
                    var x = updateCursor.getScreenX(_width);
                    var y = updateCursor.getScreenY(_height);
                    __vis.updateTouch(updateCursor.cursorId,x,y);


                },

                onRemoveTuioCursor = function(removeCursor) {
                    //always remove, wherever finger is hovering
                    __vis.removeTouch(removeCursor.cursorId);


                },

                onAddTuioObject = function(addObject) {
                    //console.log(addObject);
                },

                onUpdateTuioObject = function(updateObject) {
                    //console.log(updateObject);
                },

                onRemoveTuioObject = function(removeObject) {
                    //console.log(removeObject);
                },

                onRefresh = function(time) {
                    //console.log(time);
                };

        client.on("addTuioCursor", onAddTuioCursor);
        client.on("updateTuioCursor", onUpdateTuioCursor);
        client.on("removeTuioCursor", onRemoveTuioCursor);
        client.on("addTuioObject", onAddTuioObject);
        client.on("updateTuioObject", onUpdateTuioObject);
        client.on("removeTuioObject", onRemoveTuioObject);
        client.on("refresh", onRefresh);
        client.connect();

        //add mouse click
        $("body").mousedown(function(e){
            var offset = $(this).offset();
            __vis.addTouch("mouse",e.clientX - offset.left,e.clientY - offset.top);
        });
        $("body").mouseup(function(e){
            var offset = $(this).offset();
            __vis.removeTouch("mouse",e.clientX - offset.left,e.clientY - offset.top);
        });



    }

</script>
</html>
